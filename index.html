<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>IPCluster – Scaling Zopim’s frontend node servers</title>
    <link rel="stylesheet" type="text/css" href="build/build.css">
  </head>
  <body>
    <article>
      <section>
        <h1>IPCluster</h1>
        <h2>Scaling Zopim’s frontend Node.js servers</h2>
      </section>
      <section>
        <h2>Outline</h2>
        <ul>
          <li>Scaling lessons</li>
          <li>IPCluster</li>
        </ul>
      </section>
      <section>
        <h2>Kwok Yang Bin</h2>
        <ul>
          <li>Cofounder of Zopim</li>
        </ul>
      </section>
      <section>
        <h2><img src="images/zopim-best.png"></h2>
        <ul>
          <li>150,000 sites use Zopim</li>
          <li>3,000,000,000 impressions / month</li>
          <li>500,000 peak concurrent connections</li>
        </ul>
      </section>
      <section>
        <h2>10Q4 Dashboard Rewrite</h2>
        <h3>in HTML5</h3>
      </section>
      <section><img src="images/dashboard_flex.png"></section>
      <section><img src="images/dashboard_html5.png"></section>
      <section>
        <h3>Node.js mediator</h3>
        <ul>
          <li>Globally distributed servers</li>
          <li>Normalizes data to realtime </li>
          <li>“Dynamic” CDN</li>
        </ul>
      </section>
      <section>
        <h2>Node.js rocks!!!</h2>
        <ol>
          <li>vi server.js</li>
          <li>
            <pre>ab -n 100000 -c 1000 http://localhost:8080/</pre>
          </li>
          <li>
            <pre>???</pre>
          </li>
          <li>Profit!</li>
        </ol>
      </section>
      <section>
        <h2>Node.js rocks?</h2>
        <ul>
          <li>Single threaded</li>
          <li>Memory leaks</li>
        </ul>
      </section>
      <section>
        <h2>“All problems in computer science can be solved by another level of indirection”</h2>
      </section>
      <section><img src="images/enterprise_infrastructure.png"></section>
      <section>
        <h2>What We Tried</h2>
        <ul>
          <li>cluster module</li>
          <li>nginx WebSockets</li>
          <li>HA Proxy</li>
          <li>stud</li>
          <li>Forwarding socket FDs</li>
        </ul>
      </section>
      <section>
        <h2>Capturing client IP address</h2>
        <pre class="small"><code class="language-javascript">function attach(http_server) {
  // cache and clean up listeners
  var old_listeners = http_server.listeners('connection'),
  length = old_listeners.length, self = this;
  
  http_server.removeAllListeners('connection');
  http_server.on('connection', function(connection) {
    connection.on('close', clean);
    connection.on('error', function() { connection.destroy(); clean() });
    connection.on('data', intercept_IP);
    
    function intercept_IP(buffer) {
      if (!buffer.length) return;
      
      var family = buffer[0], f_length = FAMILY_LENGTH[family], remoteIP;
      
      if (!f_length) return;
      
      remoteIP = Array.prototype.slice.call(buffer, 1, 1 + f_length);
      connection.studRemoteAddress = stringifyIP(remoteIP);
      connection.__defineGetter__('remoteAddress', returnStudRemoteAddress);
      connection.encrypted = true;
      
      if (buffer.length > f_length + 1)
        pass_through(buffer.slice(1 + f_length));
      else
        connection.on('data', pass_through);
    }
    
    function pass_through(residue) {
      clean();
      
      for (var i = 0; i < length; i++)
      old_listeners[i].call(http_server, connection);
      
      connection.on('error', function self(e) {
        connection.removeListener('error', self);
        console.log(e.stack);
      });
      
      connection.emit('data', residue);
    }
    
    function clean() { connection.removeAllListeners() }
  });
}

function returnStudRemoteAddress() { return this.studRemoteAddress }
</code></pre>
      </section>
      <section>
        <h2>What if there was a better way?</h2>
      </section>
      <section>
        <h2>Netmask Primer</h2>
        <h3>192.168.5.128/26</h3>
        <table>
          <tbody>
            <tr>
              <th></th>
              <th>Binary form</th>
              <th>Dot-decimal notation</th>
            </tr>
            <tr>
              <td>IP address</td>
              <td>11000000.10101000.00000101.10000010</td>
              <td>192.168.5.130</td>
            </tr>
            <tr>
              <td>Subnet mask</td>
              <td>11111111.11111111.11111111.11000000</td>
              <td>255.255.255.192</td>
            </tr>
            <tr>
              <td>Network prefix</td>
              <td>11000000.10101000.00000101.10000000</td>
              <td>192.168.5.128</td>
            </tr>
            <tr>
              <td>Host part</td>
              <td>00000000.00000000.00000000.00000010</td>
              <td>0.0.0.2</td>
            </tr>
          </tbody>
        </table>
      </section>
      <section>
        <h2>Abusing Netmask Matching</h2>
      </section>
      <section>
        <h2>Linux Netfilter</h2>
        <pre><code class="language-bash">iptables -A PREROUTING -s 0.0.0.0/0.0.0.3 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 10080
iptables -A PREROUTING -s 0.0.0.1/0.0.0.3 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 10081
iptables -A PREROUTING -s 0.0.0.2/0.0.0.3 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 10082
iptables -A PREROUTING -s 0.0.0.3/0.0.0.3 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 10083
</code></pre>
      </section>
      <section>
        <h2>Remaining Issues</h2>
        <ul>
          <li>Memory leaks</li>
          <li>Restarts disconnect users</li>
          <li>Human error inserting rules</li>
        </ul>
      </section>
      <section>
        <h2>Introducing IPCluster</h2>
        <h3>Eschew "Enterprise” topologies, embrace a bare-metal topology</h3>
      </section>
      <section>
        <h2>IPCluster Features</h2>
        <ul>
          <li>Multicore</li>
          <li>Graceful worker retirement</li>
          <li>Hot code reload</li>
          <li>Bare metal</li>
          <li>Detects and retires workers that are too_busy</li>
        </ul>
      </section>
      <section>
        <h2>Design</h2>
        <ul>
          <li>Master manages workers</li>
          <li>Workers select listening port</li>
          <li>Communicates over UDS</li>
          <li>Master manages iptables</li>
          <li>Master manages masters</li>
        </ul>
      </section>
      <section>
        <h2>Retiring Workers</h2>
        <ul>
          <li>Retire workings when approaching memory limit</li>
          <li>Retire Unresponsive workers</li>
          <li>Kill workers when approaching cluster limit</li>
        </ul>
      </section>
      <section>
        <h2>IPCluster – Future</h2>
        <ul>
          <li>Automatic heap diff'ing</li>
          <li>Management GUI</li>
        </ul>
      </section>
      <section>
        <h2>Acknowledgements</h2>
        <ul>
          <li></li>
        </ul>
      </section>
      <section>
        <h2>That's all folks!</h2>
      </section>
    </article>
    <script src="build/build.js"></script>
  </body>
</html>