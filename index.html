<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>IPCluster – Scaling Zopim’s frontend node servers</title>
    <link rel="stylesheet" type="text/css" href="build/build.css">
  </head>
  <body>
    <article>
      <section>
        <h1>Scaling Zopim’s frontend node servers</h1>
        <h2>Enterprise Infrastructure and IPCluster</h2>
      </section>
      <section>
        <h2>Outline</h2>
        <ul>
          <li>Scaling</li>
          <li>IPCluster</li>
        </ul>
      </section>
      <section>
        <h2>Kwok Yang Bin</h2>
        <ul>
          <li>Cofounder of Zopim</li>
        </ul>
      </section>
      <section>
        <h2><img src="images/zopim-best.png"></h2>
      </section>
      <section>
        <h2>Stats</h2>
        <ul>
          <li>150,000 sites use Zopim</li>
          <li>3,000,000,000 impressions / month</li>
          <li>500,000 peak concurrent connections</li>
        </ul>
      </section>
      <section>
        <h2>10Q4 Dashboard Rewrite</h2>
        <h3>in HTML5</h3>
        <h3>Node.js mediator</h3>
        <ul>
          <li>Globally distributed servers</li>
          <li>Normalizes data to realtime </li>
          <li>A form of dynamic CDN – </li><a href="https://engineering.linkedin.com/performance/how-linkedin-used-pops-and-rum-make-dynamic-content-download-25-faster"></a>
        </ul>
      </section>
      <section>
        <h2>“All problems in computer science can be solved by another level of indirection”</h2>
      </section>
      <section>
        <h2>Typical NodeJS Project Lifecycle</h2>
        <h3>NodeJS starts fast out of the gate, but multi-core/-node and memory leaks can be a deal breaker</h3>
      </section>
      <section>
        <h2>"Enterprise" Node.js Scaling</h2>
        <h3>Of SSL terminators, load balancers, firewalls and DDoS mitigation</h3>
      </section>
      <section>
        <h2>What We Tried</h2>
        <ul>
          <li>cluster module</li>
          <li>nginx WebSockets</li>
          <li>HA Proxy</li>
          <li>stud</li>
          <li>Forwarding socket FDs</li>
        </ul>
      </section>
      <section>
        <h2>Capturing client IP address</h2>
        <pre><code class="language-javascript">function attach(http_server) {
  // cache and clean up listeners
  var old_listeners = http_server.listeners('connection'),
  length = old_listeners.length, self = this;
  
  http_server.removeAllListeners('connection');
  http_server.on('connection', function(connection) {
    connection.on('close', clean);
    connection.on('error', function() { connection.destroy(); clean() });
    connection.on('data', intercept_IP);
    
    function intercept_IP(buffer) {
      if (!buffer.length) return;
      
      var family = buffer[0], f_length = FAMILY_LENGTH[family], remoteIP;
      
      if (!f_length) return;
      
      remoteIP = Array.prototype.slice.call(buffer, 1, 1 + f_length);
      connection.studRemoteAddress = stringifyIP(remoteIP);
      connection.__defineGetter__('remoteAddress', returnStudRemoteAddress);
      connection.encrypted = true;
      
      if (buffer.length > f_length + 1)
        pass_through(buffer.slice(1 + f_length));
      else
        connection.on('data', pass_through);
    }
    
    function pass_through(residue) {
      clean();
      
      for (var i = 0; i < length; i++)
      old_listeners[i].call(http_server, connection);
      
      connection.on('error', function self(e) {
        connection.removeListener('error', self);
        console.log(e.stack);
      });
      
      connection.emit('data', residue);
    }
    
    function clean() { connection.removeAllListeners() }
  });
}

function returnStudRemoteAddress() { return this.studRemoteAddress }
</code></pre>
      </section>
      <section>
        <h2>Bare-metal Cluster?</h2>
        <h3>What if there was a better way?</h3>
      </section>
      <section>
        <h2>Netmask Primer</h2>
      </section>
      <section>
        <h2>Abusing Netmask Matching</h2>
      </section>
      <section>
        <h2>Linux Netfilter</h2>
        <pre>
          <iptables>-A PREROUTING -s 0.0.0.0/0.0.0.3 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 10080</iptables>
          <iptables>-A PREROUTING -s 0.0.0.1/0.0.0.3 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 10081</iptables>
          <iptables>-A PREROUTING -s 0.0.0.2/0.0.0.3 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 10082</iptables>
          <iptables>-A PREROUTING -s 0.0.0.3/0.0.0.3 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 10083</iptables></pre>
      </section>
      <section>
        <h2>Remaining Issues</h2>
        <ul>
          <li>Memory leaks</li>
          <li>Restarts disconnect users</li>
          <li>Human error inserting rules</li>
        </ul>
      </section>
      <section>
        <h2>Introducing IPCluster</h2>
        <h3>Eschew "Enterprise” topologies, embrace a bare-metal topology</h3>
      </section>
      <section>
        <h2>IPCluster Features</h2>
        <ul>
          <li>Multicore</li>
          <li>Graceful worker retirement</li>
          <li>Hot code reload</li>
          <li>Bare metal</li>
          <li>Detects and retires workers that are too_busy</li>
        </ul>
      </section>
      <section>
        <h2>Design</h2>
        <ul>
          <li>Master manages workers</li>
          <li>Workers select listening port</li>
          <li>Communicates over UDS</li>
          <li>Master manages iptables</li>
          <li>Master manages masters</li>
        </ul>
      </section>
      <section>
        <h2>Retiring Workers</h2>
        <ul>
          <li>Retire workings when approaching memory limit</li>
          <li>Retire Unresponsive workers</li>
          <li>Kill workers when approaching cluster limit</li>
        </ul>
      </section>
      <section>
        <h2>IPCluster – Future</h2>
        <ul>
          <li>Automatic heap diff'ing</li>
          <li>Management GUI</li>
        </ul>
      </section>
      <section>
        <h2>Acknowledgements</h2>
        <ul>
          <li></li>
        </ul>
      </section>
      <section>
        <h2>That's all folks!</h2>
      </section>
    </article>
    <script src="build/build.js"></script>
  </body>
</html>